"""
GameRules クラスのテスト

振る舞い駆動でテストを記述。
テスト名は日本語で、GameRules クラスが提供すべき振る舞いを表現する。
"""

import sys
import os

# domain パッケージをインポートできるようにパスを追加
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from domain.board import Board
from domain.game_rules import GameRules


def test_隣接マスに相手のコマがあり自分のコマで挟める場合ひっくり返せると判定する():
    """
    指定位置から指定方向に進んだとき、
    相手のコマが1つ以上連続し、その先に自分のコマがあれば、
    ひっくり返せると判定する
    """
    # Given: 黒が(2,4)に置くと下方向に白をひっくり返せる盤面
    #    0 1 2 3 4 5 6 7
    # 0  . . . . . . . .
    # 1  . . . . . . . .
    # 2  . . . . ? . . .  ← ここに黒を置く
    # 3  . . . B W . . .
    # 4  . . . W B . . .  ← (3,4)=W, (4,4)=B
    # 5  . . . . . . . .
    # 6  . . . . . . . .
    # 7  . . . . . . . .
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (2,4)から下方向(1,0)にひっくり返せるかチェック
    結果 = ルール.can_flip_in_direction(2, 4, 1, 0, 'B')

    # Then: ひっくり返せる（相手のコマWを挟んで自分のコマBがある）
    assert 結果 is True


def test_隣接マスに相手のコマがない場合ひっくり返せないと判定する():
    """
    指定位置の隣接マスに相手のコマがない場合、
    ひっくり返せないと判定する
    """
    # Given: (2,4)の下に相手のコマがない盤面
    #    0 1 2 3 4 5 6 7
    # 0  . . . . . . . .
    # 1  . . . . . . . .
    # 2  . . . . ? . . .  ← ここから下方向をチェック
    # 3  . . . B B . . .  ← (3,4)=B（相手のコマではない）
    # 4  . . . W B . . .
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'B', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (2,4)から下方向(1,0)にひっくり返せるかチェック
    結果 = ルール.can_flip_in_direction(2, 4, 1, 0, 'B')

    # Then: ひっくり返せない（隣接マスに相手のコマがない）
    assert 結果 is False


def test_相手のコマの先に自分のコマがない場合ひっくり返せないと判定する():
    """
    相手のコマが連続していても、その先に自分のコマがない場合、
    ひっくり返せないと判定する
    """
    # Given: (2,4)の下に相手のコマはあるが、その先に自分のコマがない盤面
    #    0 1 2 3 4 5 6 7
    # 0  . . . . . . . .
    # 1  . . . . . . . .
    # 2  . . . . ? . . .  ← ここから下方向をチェック
    # 3  . . . B W . . .  ← (3,4)=W（相手のコマ）
    # 4  . . . W W . . .  ← (4,4)=W（相手のコマ）
    # 5  . . . . . . . .  ← (5,4)=.（空マス、自分のコマがない）
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'W', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (2,4)から下方向(1,0)にひっくり返せるかチェック
    結果 = ルール.can_flip_in_direction(2, 4, 1, 0, 'B')

    # Then: ひっくり返せない（相手のコマの先に自分のコマがない）
    assert 結果 is False


def test_盤面外に出る場合ひっくり返せないと判定する():
    """
    指定方向に進むと盤面外に出る場合、
    ひっくり返せないと判定する
    """
    # Given: (0,0)から上方向は盤面外
    盤面データ = [
        ['B', 'W', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (0,0)から上方向(-1,0)にひっくり返せるかチェック
    結果 = ルール.can_flip_in_direction(0, 0, -1, 0, 'B')

    # Then: ひっくり返せない（盤面外に出る）
    assert 結果 is False


def test_8方向全てで正しく判定できる():
    """
    8方向（上下左右斜め）全てで正しくひっくり返し判定ができる
    """
    # Given: (3,3)を中心に8方向全てに相手のコマを挟める盤面
    #    0 1 2 3 4 5 6 7
    # 0  . . . . . . . .
    # 1  . B B B B B . .
    # 2  . B W W W B . .
    # 3  . B W ? W B . .  ← (3,3)に黒を置く
    # 4  . B W W W B . .
    # 5  . B B B B B . .
    # 6  . . . . . . . .
    # 7  . . . . . . . .
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', 'B', 'B', 'B', 'B', 'B', '.', '.'],
        ['.', 'B', 'W', 'W', 'W', 'B', '.', '.'],
        ['.', 'B', 'W', '.', 'W', 'B', '.', '.'],
        ['.', 'B', 'W', 'W', 'W', 'B', '.', '.'],
        ['.', 'B', 'B', 'B', 'B', 'B', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When & Then: 8方向全てでひっくり返せる
    方向リスト = [
        (-1, -1),  # 左上
        (-1, 0),   # 上
        (-1, 1),   # 右上
        (0, -1),   # 左
        (0, 1),    # 右
        (1, -1),   # 左下
        (1, 0),    # 下
        (1, 1),    # 右下
    ]

    for dr, dc in 方向リスト:
        結果 = ルール.can_flip_in_direction(3, 3, dr, dc, 'B')
        assert 結果 is True, f"方向({dr}, {dc})でひっくり返せるはずだが、Falseが返された"


def test_空マスで少なくとも1方向にひっくり返せる場合は合法手と判定する():
    """
    空マスで、8方向のうち少なくとも1方向にコマをひっくり返せる場合、
    その位置は合法手と判定される
    """
    # Given: (2,4)に黒を置くと下方向にひっくり返せる盤面
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (2,4)が合法手かチェック
    結果 = ルール.is_legal_move(2, 4, 'B')

    # Then: 合法手と判定される
    assert 結果 is True


def test_既にコマがある位置は合法手ではないと判定する():
    """
    既にコマが配置されている位置は、
    合法手ではないと判定される
    """
    # Given: (3,3)に既に黒のコマがある盤面
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (3,3)が合法手かチェック
    結果 = ルール.is_legal_move(3, 3, 'B')

    # Then: 合法手ではないと判定される（既にコマがある）
    assert 結果 is False


def test_どの方向にもひっくり返せない空マスは合法手ではないと判定する():
    """
    空マスでも、8方向のどの方向にもコマをひっくり返せない場合、
    その位置は合法手ではないと判定される
    """
    # Given: (0,0)に黒を置いてもどの方向にもひっくり返せない盤面
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)
    ルール = GameRules(盤面)

    # When: (0,0)が合法手かチェック
    結果 = ルール.is_legal_move(0, 0, 'B')

    # Then: 合法手ではないと判定される（どの方向にもひっくり返せない）
    assert 結果 is False
