"""
Board クラスのテスト

振る舞い駆動でテストを記述。
テスト名は日本語で、Board クラスが提供すべき振る舞いを表現する。
"""

import pytest
import sys
import os

# domain パッケージをインポートできるようにパスを追加
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from domain.board import Board


def test_盤面を初期化できる():
    """
    8x8の盤面データを渡すと、Board オブジェクトが初期化される
    """
    # Given: 8x8の盤面データ
    盤面データ = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # When: Board を初期化する
    盤面 = Board(盤面データ)

    # Then: 盤面が正しく初期化されている
    assert 盤面.get_cell(3, 3) == 'B'
    assert 盤面.get_cell(3, 4) == 'W'
    assert 盤面.get_cell(4, 3) == 'W'
    assert 盤面.get_cell(4, 4) == 'B'
    assert 盤面.get_cell(0, 0) == '.'


def test_指定位置のセルを取得できる():
    """
    指定した行・列の位置のセルの値を取得できる
    """
    # Given: コマが配置された盤面
    盤面データ = [
        ['B', 'W', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', 'B'],
    ]
    盤面 = Board(盤面データ)

    # When & Then: 各位置のセルを取得すると正しい値が返る
    assert 盤面.get_cell(0, 0) == 'B'
    assert 盤面.get_cell(0, 1) == 'W'
    assert 盤面.get_cell(0, 2) == '.'
    assert 盤面.get_cell(7, 7) == 'B'


def test_位置が盤面内かどうか判定できる():
    """
    指定した位置が8x8の盤面内かどうかを判定できる
    """
    # Given: 盤面
    盤面データ = [['.'] * 8 for _ in range(8)]
    盤面 = Board(盤面データ)

    # When & Then: 盤面内の位置は True を返す
    assert 盤面.is_valid_position(0, 0) is True
    assert 盤面.is_valid_position(7, 7) is True
    assert 盤面.is_valid_position(3, 4) is True

    # When & Then: 盤面外の位置は False を返す
    assert 盤面.is_valid_position(-1, 0) is False
    assert 盤面.is_valid_position(0, -1) is False
    assert 盤面.is_valid_position(8, 0) is False
    assert 盤面.is_valid_position(0, 8) is False
    assert 盤面.is_valid_position(10, 10) is False


def test_位置が空マスかどうか判定できる():
    """
    指定した位置が空マス（'.'）かどうかを判定できる
    """
    # Given: 一部にコマが配置された盤面
    盤面データ = [
        ['B', 'W', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)

    # When & Then: 空マスは True を返す
    assert 盤面.is_empty(0, 2) is True
    assert 盤面.is_empty(5, 5) is True

    # When & Then: コマがある位置は False を返す
    assert 盤面.is_empty(0, 0) is False  # 'B'
    assert 盤面.is_empty(0, 1) is False  # 'W'


def test_盤面データのコピーを取得できる():
    """
    盤面の内部データのコピーを取得できる
    コピーなので、変更しても元の盤面には影響しない
    """
    # Given: 盤面
    盤面データ = [
        ['B', 'W', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]
    盤面 = Board(盤面データ)

    # When: 盤面データのコピーを取得する
    コピーされた盤面データ = 盤面.to_grid()

    # Then: コピーされたデータは元のデータと同じ値を持つ
    assert コピーされた盤面データ[0][0] == 'B'
    assert コピーされた盤面データ[0][1] == 'W'

    # When: コピーを変更する
    コピーされた盤面データ[0][0] = 'X'

    # Then: 元の盤面は変更されていない
    assert 盤面.get_cell(0, 0) == 'B'


def test_相手プレイヤーを取得できる():
    """
    プレイヤー（'B' または 'W'）を渡すと、相手プレイヤーを返す
    """
    # When & Then: 'B' の相手は 'W'
    assert Board.get_opponent('B') == 'W'

    # When & Then: 'W' の相手は 'B'
    assert Board.get_opponent('W') == 'B'
