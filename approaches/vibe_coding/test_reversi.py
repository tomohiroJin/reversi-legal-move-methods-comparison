"""
リバーシ合法手判定プログラムのテスト (vibe_coding アプローチ)

実装後にテストを書くスタイル。
問題文の例を最優先でテストし、その後基本的なケースを追加。
"""

import pytest
from reversi import (
    find_legal_moves,
    is_legal_move,
    can_flip_in_direction,
)


def test_initial_position():
    """
    問題文の初期配置でのテスト
    期待される合法手: (2,4), (3,5), (4,2), (5,3)
    """
    # 初期盤面を作成
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    legal_moves = find_legal_moves(board, 'B')
    expected = [(2, 4), (3, 5), (4, 2), (5, 3)]

    # 順序は問わないのでソートして比較
    assert sorted(legal_moves) == sorted(expected)


def test_white_initial_position():
    """
    白番の初期配置でのテスト
    期待される合法手: (2,3), (3,2), (4,5), (5,4)
    """
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    legal_moves = find_legal_moves(board, 'W')
    expected = [(2, 3), (3, 2), (4, 5), (5, 4)]

    assert sorted(legal_moves) == sorted(expected)


def test_no_legal_moves():
    """
    合法手がない場合のテスト
    全てのマスが埋まっている場合
    """
    # 全て埋まっている盤面
    board = [
        ['B', 'B', 'B', 'B', 'W', 'W', 'W', 'W'],
        ['B', 'B', 'B', 'B', 'W', 'W', 'W', 'W'],
        ['B', 'B', 'B', 'B', 'W', 'W', 'W', 'W'],
        ['B', 'B', 'B', 'B', 'W', 'W', 'W', 'W'],
        ['W', 'W', 'W', 'W', 'B', 'B', 'B', 'B'],
        ['W', 'W', 'W', 'W', 'B', 'B', 'B', 'B'],
        ['W', 'W', 'W', 'W', 'B', 'B', 'B', 'B'],
        ['W', 'W', 'W', 'W', 'B', 'B', 'B', 'B'],
    ]

    legal_moves = find_legal_moves(board, 'B')
    assert legal_moves == []


def test_corner_position():
    """
    角への配置テスト
    角は重要な手なので確実にテスト
    """
    # 左上の角が取れる状況
    board = [
        ['.', 'W', '.', '.', '.', '.', '.', '.'],
        ['W', 'W', '.', '.', '.', '.', '.', '.'],
        ['.', '.', 'B', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # (0, 0) が合法手であることを確認
    assert is_legal_move(board, 0, 0, 'B')
    legal_moves = find_legal_moves(board, 'B')
    assert (0, 0) in legal_moves


def test_multiple_directions():
    """
    1つの手で複数方向に同時にひっくり返せるケース
    """
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', 'W', '.', '.', '.', '.', '.'],
        ['.', 'W', '.', 'W', '.', '.', '.', '.'],
        ['.', '.', 'W', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # (2, 2) に黒を置くと、複数方向にひっくり返せる
    # 周りに黒を配置
    board[0][2] = 'B'  # 上
    board[2][0] = 'B'  # 左
    board[4][2] = 'B'  # 下
    board[2][4] = 'B'  # 右

    assert is_legal_move(board, 2, 2, 'B')


def test_edge_positions():
    """
    盤面の端での合法手判定
    """
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['W', 'W', 'W', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    legal_moves = find_legal_moves(board, 'B')
    # (3, 5) が合法手（右方向にひっくり返せる）
    assert (3, 5) in legal_moves


def test_can_flip_in_direction_basic():
    """
    can_flip_in_direction 関数の基本テスト
    """
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # (2, 4) から下方向 (1, 0) にひっくり返せるか
    assert can_flip_in_direction(board, 2, 4, 1, 0, 'B') is True

    # (2, 4) から右方向 (0, 1) にひっくり返せないか
    assert can_flip_in_direction(board, 2, 4, 0, 1, 'B') is False


def test_is_legal_move_occupied():
    """
    既にコマがあるマスは合法手ではない
    """
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', 'B', 'W', '.', '.', '.'],
        ['.', '.', '.', 'W', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # (3, 3) には既に黒がある
    assert is_legal_move(board, 3, 3, 'B') is False
    # (3, 4) には既に白がある
    assert is_legal_move(board, 3, 4, 'W') is False


def test_all_eight_directions():
    """
    8方向全てで正しくひっくり返し判定ができるか
    """
    # 中央に白を配置し、周囲8方向に黒を配置
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', 'B', 'B', 'B', '.', '.', '.'],
        ['.', '.', 'B', 'W', 'B', '.', '.', '.'],
        ['.', '.', 'B', 'B', 'B', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # 中央の白は周囲8マス全てが合法手になるはず
    # しかし、盤面上の白は1つだけで黒に囲まれているので、
    # 白番で打てる場所は中央の周囲の空マス
    # この盤面では白番で打てる場所がないので、黒番でテスト

    # 実際には、この盤面では黒番でも打てる場所がないはず
    # （周囲の黒の外側には白がないので）

    # テストケースを修正：中央に黒、周囲に白、さらに外側に黒を配置
    board = [
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', 'B', 'B', 'B', 'B', 'B', '.', '.'],
        ['.', 'B', 'W', 'W', 'W', 'B', '.', '.'],
        ['.', 'B', 'W', '.', 'W', 'B', '.', '.'],
        ['.', 'B', 'W', 'W', 'W', 'B', '.', '.'],
        ['.', 'B', 'B', 'B', 'B', 'B', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
    ]

    # (3, 3) に黒を置くと、8方向全てに白をひっくり返せる
    assert is_legal_move(board, 3, 3, 'B')

    # 各方向を個別にチェック
    directions = [
        (-1, -1), (-1, 0), (-1, 1),
        (0, -1),           (0, 1),
        (1, -1),  (1, 0),  (1, 1)
    ]

    for dr, dc in directions:
        assert can_flip_in_direction(board, 3, 3, dr, dc, 'B')
